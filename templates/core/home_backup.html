{% extends 'base.html' %}

{% block title %}Inicio - Cafeter√≠as de Sucre{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-coffee-600 to-coffee-800 rounded-lg p-8 text-white">
        <div class="max-w-3xl">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-coffee mr-3"></i>
                Descubre las Mejores Cafeter√≠as de Sucre
            </h1>
            <p class="text-xl mb-6">
                Crea tu ruta personalizada de 4 cafeter√≠as en Sucre. ¬°Usa el asistente virtual para encontrar tu caf√© perfecto!
            </p>
            {% if user.is_authenticated %}
                <div class="flex space-x-4">
                    <button onclick="scrollToMap()" class="bg-white text-coffee-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition duration-200">
                        <i class="fas fa-map mr-2"></i>
                        Ver Mapa
                    </button>
                    <button onclick="document.getElementById('chatbot-toggle').click()" class="bg-coffee-500 hover:bg-coffee-400 text-white px-6 py-3 rounded-lg font-semibold transition duration-200">
                        <i class="fas fa-robot mr-2"></i>
                        Crear Mi Ruta
                    </button>
                </div>
            {% else %}
                <a href="{% url 'registro' %}" class="bg-white text-coffee-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition duration-200 inline-block">
                    <i class="fas fa-user-plus mr-2"></i>
                    Registrarse para Crear Ruta
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="text-3xl font-bold text-coffee-600 mb-2">{{ cafeterias.count }}</div>
            <div class="text-gray-600">Cafeter√≠as Registradas</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="text-3xl font-bold text-coffee-600 mb-2">{{ recorridos.count }}</div>
            <div class="text-gray-600">Recorridos Disponibles</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="text-3xl font-bold text-coffee-600 mb-2">
                <i class="fas fa-users"></i>
            </div>
            <div class="text-gray-600">Comunidad Activa</div>
        </div>
    </div>

    <!-- Featured Cafeter√≠as -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
            <i class="fas fa-star mr-2 text-yellow-500"></i>
            Cafeter√≠as Destacadas
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for cafeteria in cafeterias|slice:":6" %}
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition duration-200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-lg">{{ cafeteria.nombre }}</h3>
                        <div class="flex items-center">
                            <div class="flex text-yellow-400">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= cafeteria.estrellas %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="text-sm text-gray-500 ml-1">({{ cafeteria.calificacion_promedio }})</span>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm mb-3">{{ cafeteria.descripcion|truncatewords:15 }}</p>
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <span><i class="fas fa-map-marker-alt mr-1"></i>{{ cafeteria.direccion }}</span>
                        <span><i class="fas fa-heart mr-1 text-red-500"></i>{{ cafeteria.total_me_gusta }}</span>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'cafeteria_detail' cafeteria.id %}" 
                           class="bg-coffee-600 hover:bg-coffee-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            Ver Detalles
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Map Section -->
    <div id="map-section" class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
            <i class="fas fa-map mr-2 text-blue-500"></i>
            Mapa de Cafeter√≠as
        </h2>
        
        <!-- Mapa simple con iframe de Google Maps como respaldo -->
        <div class="w-full h-96 rounded-lg border border-gray-300 mb-6 relative">
            <div id="custom-map" class="w-full h-full rounded-lg"></div>
            <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center rounded-lg">
                <div class="text-center">
                    <div class="animate-spin w-8 h-8 border-4 border-coffee-600 border-t-transparent rounded-full mx-auto mb-2"></div>
                    <p class="text-gray-600 text-sm">Cargando mapa...</p>
                </div>
            </div>
        </div>
        
        <!-- Google Maps Embed como respaldo inmediato -->
        <div class="w-full h-96 rounded-lg border border-gray-300 mb-6">
            <iframe 
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d30458.234567!2d-65.2595!3d-19.0478!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x93fbcf0f1b2e8b1d%3A0x8a2f2b8e4f1c7d3e!2sSucre%2C%20Bolivia!5e0!3m2!1sen!2sus!4v1234567890"
                width="100%" 
                height="100%" 
                style="border:0; border-radius: 8px;" 
                allowfullscreen="" 
                loading="lazy" 
                referrerpolicy="no-referrer-when-downgrade"
                title="Mapa de Sucre, Bolivia">
            </iframe>
        </div>
        
        <!-- Informaci√≥n de cafeter√≠as como grid visual -->
        <div id="cafeterias-visual-map" class="mt-6">
            <h3 class="text-xl font-semibold mb-4 text-coffee-700">üìç Mapa Visual de Cafeter√≠as por Zona:</h3>
            
            <!-- Centro -->
            <div class="mb-6 p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                <h4 class="font-bold text-lg text-red-700 mb-3">üèõÔ∏è ZONA CENTRO (8 cafeter√≠as)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                    {% for cafeteria in cafeterias %}
                        {% if cafeteria.zona == 'Centro' %}
                        <div class="bg-white p-3 rounded-lg shadow-sm border hover:shadow-md transition-shadow cursor-pointer"
                             onclick="window.location.href='{% url 'cafeteria_detail' cafeteria.id %}'">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">‚òï</span>
                                <h5 class="font-semibold text-sm text-coffee-700">{{ cafeteria.nombre|truncatechars:20 }}</h5>
                            </div>
                            <p class="text-xs text-gray-600 mb-1">üìç {{ cafeteria.direccion|truncatechars:25 }}</p>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-yellow-600">‚≠ê {{ cafeteria.calificacion_promedio }}</span>
                                <span class="text-red-500">‚ù§Ô∏è {{ cafeteria.total_me_gusta }}</span>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            
            <!-- Norte -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                <h4 class="font-bold text-lg text-blue-700 mb-3">üèîÔ∏è ZONA NORTE (4 cafeter√≠as)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                    {% for cafeteria in cafeterias %}
                        {% if cafeteria.zona == 'Norte' %}
                        <div class="bg-white p-3 rounded-lg shadow-sm border hover:shadow-md transition-shadow cursor-pointer"
                             onclick="window.location.href='{% url 'cafeteria_detail' cafeteria.id %}'">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">‚òï</span>
                                <h5 class="font-semibold text-sm text-coffee-700">{{ cafeteria.nombre|truncatechars:20 }}</h5>
                            </div>
                            <p class="text-xs text-gray-600 mb-1">üìç {{ cafeteria.direccion|truncatechars:25 }}</p>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-yellow-600">‚≠ê {{ cafeteria.calificacion_promedio }}</span>
                                <span class="text-red-500">‚ù§Ô∏è {{ cafeteria.total_me_gusta }}</span>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            
            <!-- Sur -->
            <div class="mb-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                <h4 class="font-bold text-lg text-green-700 mb-3">üå≥ ZONA SUR (3 cafeter√≠as)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                    {% for cafeteria in cafeterias %}
                        {% if cafeteria.zona == 'Sur' %}
                        <div class="bg-white p-3 rounded-lg shadow-sm border hover:shadow-md transition-shadow cursor-pointer"
                             onclick="window.location.href='{% url 'cafeteria_detail' cafeteria.id %}'">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">‚òï</span>
                                <h5 class="font-semibold text-sm text-coffee-700">{{ cafeteria.nombre|truncatechars:20 }}</h5>
                            </div>
                            <p class="text-xs text-gray-600 mb-1">üìç {{ cafeteria.direccion|truncatechars:25 }}</p>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-yellow-600">‚≠ê {{ cafeteria.calificacion_promedio }}</span>
                                <span class="text-red-500">‚ù§Ô∏è {{ cafeteria.total_me_gusta }}</span>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            
            <!-- Este -->
            <div class="mb-6 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                <h4 class="font-bold text-lg text-yellow-700 mb-3">üåÖ ZONA ESTE (5 cafeter√≠as)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                    {% for cafeteria in cafeterias %}
                        {% if cafeteria.zona == 'Este' %}
                        <div class="bg-white p-3 rounded-lg shadow-sm border hover:shadow-md transition-shadow cursor-pointer"
                             onclick="window.location.href='{% url 'cafeteria_detail' cafeteria.id %}'">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2">‚òï</span>
                                <h5 class="font-semibold text-sm text-coffee-700">{{ cafeteria.nombre|truncatechars:20 }}</h5>
                            </div>
                            <p class="text-xs text-gray-600 mb-1">üìç {{ cafeteria.direccion|truncatechars:25 }}</p>
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-yellow-600">‚≠ê {{ cafeteria.calificacion_promedio }}</span>
                                <span class="text-red-500">‚ù§Ô∏è {{ cafeteria.total_me_gusta }}</span>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recorridos Disponibles -->
    {% if recorridos %}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-route mr-2 text-green-500"></i>
                Recorridos Disponibles
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for recorrido in recorridos %}
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold text-lg mb-2">{{ recorrido.nombre }}</h3>
                        <p class="text-gray-600 text-sm mb-3">{{ recorrido.descripcion }}</p>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
                            <span><i class="fas fa-clock mr-1"></i>{{ recorrido.duracion_estimada }} min</span>
                            <span><i class="fas fa-route mr-1"></i>{{ recorrido.distancia_total }} km</span>
                            <span><i class="fas fa-coffee mr-1"></i>{{ recorrido.cafeterias.count }} cafeter√≠as</span>
                        </div>
                        {% if user.is_authenticated %}
                            <a href="{% url 'iniciar_recorrido' recorrido.id %}" 
                               class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                <i class="fas fa-play mr-1"></i>
                                Iniciar Recorrido
                            </a>
                        {% else %}
                            <a href="{% url 'registro' %}" 
                               class="bg-gray-400 text-white px-4 py-2 rounded-lg text-sm cursor-not-allowed">
                                Registrarse para Iniciar
                            </a>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<script>
    function scrollToMap() {
        document.getElementById('map-section').scrollIntoView({ behavior: 'smooth' });
    }

    // Initialize Mapbox
    let map, userMarker;
    let nearestCafes = [];
    let mapboxLoaded = false;

    function showMapError(message) {
        document.getElementById('map-loading').style.display = 'none';
        document.getElementById('map-error').style.display = 'flex';
        console.error('üö® Error de mapa:', message);
    }

    function hideMapLoading() {
        document.getElementById('map-loading').style.display = 'none';
        document.getElementById('map-error').style.display = 'none';
    }

    function retryMap() {
        document.getElementById('map-error').style.display = 'none';
        document.getElementById('map-loading').style.display = 'flex';
        setTimeout(() => {
            initMap();
        }, 1000);
    }

    function initMap() {
        console.log('üó∫Ô∏è Iniciando mapa...');
        
        try {
            // Verificar si Mapbox est√° disponible
            if (typeof mapboxgl === 'undefined') {
                throw new Error('Mapbox GL JS no est√° cargado');
            }
            
            mapboxgl.accessToken = '{{ MAPBOX_ACCESS_TOKEN }}';
            console.log('üîë Token de Mapbox configurado');
            
            // Verificar token
            if (!mapboxgl.accessToken || mapboxgl.accessToken === '') {
                throw new Error('Token de Mapbox no configurado');
            }
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [-65.2595, -19.0478], // [lng, lat] para Mapbox - Centro de Sucre
                zoom: 13
            });

            console.log('üó∫Ô∏è Mapa creado, esperando carga...');

            map.on('load', function () {
                console.log('‚úÖ Mapa cargado exitosamente');
                hideMapLoading();
                addCafeteriaMarkers();
            });

            map.on('error', function (e) {
                console.error('‚ùå Error del mapa:', e);
                showMapError('Error al cargar el mapa de Mapbox');
            });

            // Timeout de seguridad
            setTimeout(() => {
                if (!mapboxLoaded) {
                    console.warn('‚è∞ Timeout cargando mapa');
                    showMapError('El mapa tard√≥ demasiado en cargar');
                }
            }, 10000);

        } catch (error) {
            console.error('‚ùå Error al inicializar mapa:', error);
            showMapError(error.message);
        }
    }

    function addCafeteriaMarkers() {
        console.log('üìç Agregando marcadores de cafeter√≠as...');

        // Add markers for cafeter√≠as (data del servidor)
        const cafeterias = [
            {% for cafeteria in cafeterias %}
                {
                    id: {{ cafeteria.id }},
                    nombre: "{{ cafeteria.nombre|escapejs }}",
                    direccion: "{{ cafeteria.direccion|escapejs }}",
                    lat: {{ cafeteria.latitud }},
                    lng: {{ cafeteria.longitud }},
                    calificacion: {{ cafeteria.calificacion_promedio }},
                    me_gusta: {{ cafeteria.total_me_gusta }},
                    zona: "{{ cafeteria.zona }}"
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        console.log(`ÔøΩ Total cafeter√≠as a mostrar: ${cafeterias.length}`);
        
        if (cafeterias.length === 0) {
            console.warn('‚ö†Ô∏è No hay cafeter√≠as para mostrar');
            showMapError('No hay cafeter√≠as disponibles');
            return;
        }
        
        // Agregar marcadores para todas las cafeter√≠as
        let markersAdded = 0;
        cafeterias.forEach((cafe, index) => {
            try {
                console.log(`üìå Agregando marcador ${index + 1}: ${cafe.nombre}`);
                
                // Crear elemento para cada marcador individualemente
                const el = document.createElement('div');
                el.className = 'marker';
                el.innerHTML = '‚òï';
                el.style.backgroundColor = '#d65a1a';
                el.style.color = 'white';
                el.style.width = '30px';
                el.style.height = '30px';
                el.style.borderRadius = '50%';
                el.style.border = '2px solid white';
                el.style.display = 'flex';
                el.style.alignItems = 'center';
                el.style.justifyContent = 'center';
                el.style.fontSize = '14px';
                el.style.cursor = 'pointer';
                el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';

                const marker = new mapboxgl.Marker(el)
                    .setLngLat([cafe.lng, cafe.lat])
                    .addTo(map);

                const popup = new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`
                        <div class="p-3 min-w-64">
                            <h3 class="font-semibold text-lg mb-2">${cafe.nombre}</h3>
                            <p class="text-sm text-gray-600 mb-2">üìç ${cafe.direccion}</p>
                            <p class="text-sm text-blue-600 mb-2">üèôÔ∏è Zona ${cafe.zona}</p>
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="flex text-yellow-400">
                                        ${'‚òÖ'.repeat(Math.floor(cafe.calificacion))}${'‚òÜ'.repeat(5 - Math.floor(cafe.calificacion))}
                                    </div>
                                    <span class="text-xs text-gray-500 ml-1">(${cafe.calificacion})</span>
                                </div>
                                <span class="text-xs text-red-500">‚ù§Ô∏è ${cafe.me_gusta}</span>
                            </div>
                            <a href="/cafeteria/${cafe.id}/" 
                               class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm transition duration-200 inline-block">
                                Ver Detalles
                            </a>
                        </div>
                    `);

                marker.setPopup(popup);
                markersAdded++;
                
            } catch (error) {
                console.error(`‚ùå Error agregando marcador para ${cafe.nombre}:`, error);
            }
        });

        console.log(`‚úÖ ${markersAdded} marcadores agregados al mapa`);

        // Ajustar la vista para mostrar todas las cafeter√≠as
        if (markersAdded > 0) {
            try {
                const bounds = new mapboxgl.LngLatBounds();
                cafeterias.forEach(cafe => {
                    bounds.extend([cafe.lng, cafe.lat]);
                });
                map.fitBounds(bounds, { 
                    padding: 50,
                    maxZoom: 15
                });
                console.log('üéØ Vista ajustada para mostrar todas las cafeter√≠as');
                mapboxLoaded = true;
            } catch (error) {
                console.error('‚ùå Error ajustando vista:', error);
            }
        }

        // Intentar geolocalizaci√≥n del usuario
        addUserLocationIfAvailable();
    }

    function addUserLocationIfAvailable() {
        if (navigator.geolocation) {
            console.log('üìç Solicitando ubicaci√≥n del usuario...');
            navigator.geolocation.getCurrentPosition((position) => {
                try {
                    const userPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    console.log(`üë§ Usuario ubicado en: ${userPos.lat}, ${userPos.lng}`);

                    // Crear marcador de usuario
                    const userEl = document.createElement('div');
                    userEl.innerHTML = 'üìç';
                    userEl.style.backgroundColor = '#2563eb';
                    userEl.style.color = 'white';
                    userEl.style.width = '30px';
                    userEl.style.height = '30px';
                    userEl.style.borderRadius = '50%';
                    userEl.style.border = '2px solid white';
                    userEl.style.display = 'flex';
                    userEl.style.alignItems = 'center';
                    userEl.style.justifyContent = 'center';
                    userEl.style.fontSize = '14px';
                    userEl.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';

                    userMarker = new mapboxgl.Marker(userEl)
                        .setLngLat([userPos.lng, userPos.lat])
                        .addTo(map);

                    // Agregar popup al marcador del usuario
                    const userPopup = new mapboxgl.Popup({ offset: 25 })
                        .setHTML('<div class="p-2"><strong>Tu ubicaci√≥n</strong></div>');
                    userMarker.setPopup(userPopup);

                    console.log('‚úÖ Marcador de usuario agregado');

                } catch (error) {
                    console.error('‚ùå Error agregando ubicaci√≥n de usuario:', error);
                }
            }, (error) => {
                console.log('‚ö†Ô∏è Error de geolocalizaci√≥n:', error.message);
            });
        } else {
            console.log('‚ö†Ô∏è Geolocalizaci√≥n no disponible');
        }
    }

    function drawRoute(origin, cafes) {
        if (!cafes || cafes.length === 0) return;
        
        // Crear coordenadas para la ruta
        const coordinates = [[origin.lng, origin.lat]];
        cafes.forEach(cafe => {
            coordinates.push([cafe.longitud || cafe.lng, cafe.latitud || cafe.lat]);
        });

        // Agregar fuente de datos para la ruta
        if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
        }

        map.addSource('route', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': coordinates
                }
            }
        });

        // Agregar capa de l√≠nea para la ruta
        map.addLayer({
            'id': 'route',
            'type': 'line',
            'source': 'route',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': '#d65a1a',
                'line-width': 4
            }
        });
    }

    // Load Mapbox API with fallback to OpenStreetMap
    function loadMapbox() {
        console.log('üöÄ Cargando API de mapas...');
        
        // Intentar cargar Mapbox primero
        const script = document.createElement('script');
        script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js';
        script.onload = () => {
            console.log('‚úÖ Mapbox GL JS cargado');
            const link = document.createElement('link');
            link.href = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css';
            link.rel = 'stylesheet';
            document.head.appendChild(link);
            
            // Inicializar mapa cuando Mapbox est√© cargado
            setTimeout(() => {
                initMap();
            }, 1000);
        };
        script.onerror = () => {
            console.warn('‚ö†Ô∏è Error cargando Mapbox, intentando OpenStreetMap...');
            loadOpenStreetMap();
        };
        document.head.appendChild(script);
    }

    function loadOpenStreetMap() {
        console.log('üó∫Ô∏è Cargando OpenStreetMap como alternativa...');
        
        // Cargar Leaflet (OpenStreetMap)
        const leafletCSS = document.createElement('link');
        leafletCSS.rel = 'stylesheet';
        leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(leafletCSS);
        
        const leafletJS = document.createElement('script');
        leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        leafletJS.onload = () => {
            console.log('‚úÖ Leaflet cargado');
            setTimeout(() => {
                initOpenStreetMap();
            }, 1000);
        };
        leafletJS.onerror = () => {
            console.error('‚ùå Error cargando Leaflet');
            showMapError('No se pudo cargar ning√∫n servicio de mapas');
        };
        document.head.appendChild(leafletJS);
    }

    function initOpenStreetMap() {
        console.log('üó∫Ô∏è Inicializando mapa OpenStreetMap...');
        
        try {
            hideMapLoading();
            
            // Crear mapa Leaflet
            const leafletMap = L.map('map').setView([-19.0478, -65.2595], 13);
            
            // Agregar capa de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(leafletMap);
            
            console.log('‚úÖ Mapa OpenStreetMap creado');
            
            // Agregar marcadores de cafeter√≠as
            const cafeterias = [
                {% for cafeteria in cafeterias %}
                    {
                        id: {{ cafeteria.id }},
                        nombre: "{{ cafeteria.nombre|escapejs }}",
                        direccion: "{{ cafeteria.direccion|escapejs }}",
                        lat: {{ cafeteria.latitud }},
                        lng: {{ cafeteria.longitud }},
                        calificacion: {{ cafeteria.calificacion_promedio }},
                        me_gusta: {{ cafeteria.total_me_gusta }},
                        zona: "{{ cafeteria.zona }}"
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            
            console.log(`üìç Agregando ${cafeterias.length} marcadores...`);
            
            const markers = [];
            cafeterias.forEach((cafe, index) => {
                try {
                    // Crear marcador personalizado
                    const coffeeIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: "<div style='background-color:#d65a1a;width:30px;height:30px;border-radius:50%;border:2px solid white;display:flex;align-items:center;justify-content:center;color:white;font-size:14px;box-shadow:0 2px 4px rgba(0,0,0,0.3);'>‚òï</div>",
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });
                    
                    const marker = L.marker([cafe.lat, cafe.lng], {icon: coffeeIcon}).addTo(leafletMap);
                    
                    // Agregar popup
                    marker.bindPopup(`
                        <div style="min-width:200px;">
                            <h3 style="font-weight:bold; font-size:16px; margin-bottom:8px;">${cafe.nombre}</h3>
                            <p style="font-size:12px; color:#666; margin-bottom:4px;">üìç ${cafe.direccion}</p>
                            <p style="font-size:12px; color:#2563eb; margin-bottom:8px;">üèôÔ∏è Zona ${cafe.zona}</p>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <div>
                                    <span style="color:#fbbf24;">‚òÖ</span>
                                    <span style="font-size:12px;">${cafe.calificacion}</span>
                                </div>
                                <span style="font-size:12px; color:#ef4444;">‚ù§Ô∏è ${cafe.me_gusta}</span>
                            </div>
                            <a href="/cafeteria/${cafe.id}/" 
                               style="background-color:#d65a1a; color:white; padding:6px 12px; border-radius:4px; text-decoration:none; font-size:12px; display:inline-block;">
                                Ver Detalles
                            </a>
                        </div>
                    `);
                    
                    markers.push(marker);
                    console.log(`‚úÖ Marcador ${index + 1} agregado: ${cafe.nombre}`);
                    
                } catch (error) {
                    console.error(`‚ùå Error agregando marcador ${cafe.nombre}:`, error);
                }
            });
            
            // Ajustar vista para mostrar todos los marcadores
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                leafletMap.fitBounds(group.getBounds().pad(0.1));
                console.log('üéØ Vista ajustada para mostrar todas las cafeter√≠as');
            }
            
            console.log(`‚úÖ Mapa OpenStreetMap completamente cargado con ${markers.length} marcadores`);
            
        } catch (error) {
            console.error('‚ùå Error inicializando OpenStreetMap:', error);
            showMapError('Error al inicializar el mapa OpenStreetMap');
        }
    }

    // Load maps when page is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üì± DOM cargado, iniciando mapas...');
        // Usar OpenStreetMap directamente como m√°s confiable
        loadOpenStreetMap();
    });
</script>
{% endblock %}
