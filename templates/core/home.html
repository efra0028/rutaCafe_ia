{% extends 'base.html' %}

{% block title %}Inicio - Cafeter√≠as de Sucre{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-coffee-600 to-coffee-800 rounded-lg p-8 text-white">
        <div class="max-w-3xl">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-coffee mr-3"></i>
                Descubre las Mejores Cafeter√≠as de Sucre
            </h1>
            <p class="text-xl mb-6">
                Crea tu ruta personalizada de 4 cafeter√≠as en Sucre. ¬°Usa el asistente virtual para encontrar tu caf√© perfecto!
            </p>
            {% if user.is_authenticated %}
                <div class="flex space-x-4">
                    <button onclick="scrollToMap()" class="bg-white text-coffee-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition duration-200">
                        <i class="fas fa-map mr-2"></i>
                        Ver Mapa
                    </button>
                    <button onclick="document.getElementById('chatbot-toggle').click()" class="bg-coffee-500 hover:bg-coffee-400 text-white px-6 py-3 rounded-lg font-semibold transition duration-200">
                        <i class="fas fa-robot mr-2"></i>
                        Crear Mi Ruta
                    </button>
                </div>
            {% else %}
                <a href="{% url 'registro' %}" class="bg-white text-coffee-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition duration-200 inline-block">
                    <i class="fas fa-user-plus mr-2"></i>
                    Registrarse para Crear Ruta
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="text-3xl font-bold text-coffee-600 mb-2">{{ cafeterias.count }}</div>
            <div class="text-gray-600">Cafeter√≠as Registradas</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="text-3xl font-bold text-coffee-600 mb-2">{{ recorridos.count }}</div>
            <div class="text-gray-600">Recorridos Disponibles</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div class="text-3xl font-bold text-coffee-600 mb-2">
                <i class="fas fa-users"></i>
            </div>
            <div class="text-gray-600">Comunidad Activa</div>
        </div>
    </div>

    <!-- Featured Cafeter√≠as -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
            <i class="fas fa-star mr-2 text-yellow-500"></i>
            Cafeter√≠as Destacadas
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for cafeteria in cafeterias|slice:":6" %}
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition duration-200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-lg">{{ cafeteria.nombre }}</h3>
                        <div class="flex items-center">
                            <div class="flex text-yellow-400">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= cafeteria.estrellas %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="text-sm text-gray-500 ml-1">({{ cafeteria.calificacion_promedio }})</span>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm mb-3">{{ cafeteria.descripcion|truncatewords:15 }}</p>
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <span><i class="fas fa-map-marker-alt mr-1"></i>{{ cafeteria.direccion }}</span>
                        <span><i class="fas fa-heart mr-1 text-red-500"></i>{{ cafeteria.total_me_gusta }}</span>
                    </div>
                    <div class="mt-3">
                        <a href="{% url 'cafeteria_detail' cafeteria.id %}" 
                           class="bg-coffee-600 hover:bg-coffee-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                            Ver Detalles
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Map Section -->
    <div id="map-section" class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">
            <i class="fas fa-map mr-2 text-blue-500"></i>
            Mapa de Cafeter√≠as
        </h2>
        <div id="map" class="w-full h-96 rounded-lg border border-gray-300">
            <!-- Google Maps will be loaded here -->
        </div>
    </div>

    <!-- Recorridos Disponibles -->
    {% if recorridos %}
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-route mr-2 text-green-500"></i>
                Recorridos Disponibles
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for recorrido in recorridos %}
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold text-lg mb-2">{{ recorrido.nombre }}</h3>
                        <p class="text-gray-600 text-sm mb-3">{{ recorrido.descripcion }}</p>
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
                            <span><i class="fas fa-clock mr-1"></i>{{ recorrido.duracion_estimada }} min</span>
                            <span><i class="fas fa-route mr-1"></i>{{ recorrido.distancia_total }} km</span>
                            <span><i class="fas fa-coffee mr-1"></i>{{ recorrido.cafeterias.count }} cafeter√≠as</span>
                        </div>
                        {% if user.is_authenticated %}
                            <a href="{% url 'iniciar_recorrido' recorrido.id %}" 
                               class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                                <i class="fas fa-play mr-1"></i>
                                Iniciar Recorrido
                            </a>
                        {% else %}
                            <a href="{% url 'registro' %}" 
                               class="bg-gray-400 text-white px-4 py-2 rounded-lg text-sm cursor-not-allowed">
                                Registrarse para Iniciar
                            </a>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>

<script>
    function scrollToMap() {
        document.getElementById('map-section').scrollIntoView({ behavior: 'smooth' });
    }

    // Initialize Mapbox
    let map, userMarker;
    let nearestCafes = [];

    function initMap() {
        mapboxgl.accessToken = '{{ MAPBOX_ACCESS_TOKEN }}';
        
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-65.2595, -19.0478], // [lng, lat] para Mapbox
            zoom: 14
        });

        // Add markers for cafeter√≠as (data del servidor)
        const cafeterias = [
            {% for cafeteria in cafeterias %}
                {
                    id: {{ cafeteria.id }},
                    nombre: "{{ cafeteria.nombre }}",
                    direccion: "{{ cafeteria.direccion }}",
                    lat: {{ cafeteria.latitud }},
                    lng: {{ cafeteria.longitud }},
                    calificacion: {{ cafeteria.calificacion_promedio }},
                    me_gusta: {{ cafeteria.total_me_gusta }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Crear elemento para el marcador personalizado
        const el = document.createElement('div');
        el.className = 'marker';
        el.style.backgroundImage = 'url(data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                <circle cx="16" cy="16" r="12" fill="#d65a1a" stroke="white" stroke-width="2"/>
                <text x="16" y="20" text-anchor="middle" fill="white" font-size="16">‚òï</text>
            </svg>
        `) + ')';
        el.style.width = '32px';
        el.style.height = '32px';
        el.style.backgroundSize = 'cover';

        cafeterias.forEach(cafe => {
            const marker = new mapboxgl.Marker(el)
                .setLngLat([cafe.lng, cafe.lat])
                .addTo(map);

            const popup = new mapboxgl.Popup({ offset: 25 })
                .setHTML(`
                    <div class="p-2">
                        <h3 class="font-semibold">${cafe.nombre}</h3>
                        <p class="text-sm text-gray-600">${cafe.direccion}</p>
                        <div class="flex items-center mt-1">
                            <div class="flex text-yellow-400">
                                ${'‚òÖ'.repeat(Math.floor(cafe.calificacion))}
                            </div>
                            <span class="text-xs text-gray-500 ml-1">${cafe.calificacion}</span>
                            <span class="text-xs text-red-500 ml-2">‚ù§Ô∏è ${cafe.me_gusta}</span>
                        </div>
                        <a href="/cafeteria/${cafe.id}/" class="text-blue-600 text-sm hover:underline">
                            Ver detalles
                        </a>
                    </div>
                `);

            marker.setPopup(popup);
        });

        // Intentar geolocalizaci√≥n del usuario
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const userPos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                map.setCenter([userPos.lng, userPos.lat]);
                map.setZoom(15);

                // Crear marcador de usuario
                const userEl = document.createElement('div');
                userEl.className = 'user-marker';
                userEl.style.backgroundImage = 'url(data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="12" fill="#2563eb" stroke="white" stroke-width="2"/>
                        <text x="16" y="20" text-anchor="middle" fill="white" font-size="16">üìç</text>
                    </svg>
                `) + ')';
                userEl.style.width = '32px';
                userEl.style.height = '32px';
                userEl.style.backgroundSize = 'cover';

                userMarker = new mapboxgl.Marker(userEl)
                    .setLngLat([userPos.lng, userPos.lat])
                    .addTo(map);

                // Buscar 4 cafeter√≠as m√°s cercanas desde backend
                fetch(`/api/cercanas/?lat=${userPos.lat}&lng=${userPos.lng}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success && data.cafeterias.length) {
                            nearestCafes = data.cafeterias;
                            const ids = nearestCafes.map(c => c.id);
                            // Ordenar por cercan√≠a incremental
                            fetch(`/api/ordenar-ruta/?lat=${userPos.lat}&lng=${userPos.lng}&` + ids.map(id => `ids=${id}`).join('&'))
                                .then(r => r.json())
                                .then(orderData => {
                                    if (orderData.success) {
                                        const ordered = orderData.orden.map(id => nearestCafes.find(c => c.id === id));
                                        drawRoute(userPos, ordered);
                                    }
                                });
                        }
                    });
            });
        }
    }

    function drawRoute(origin, cafes) {
        if (!cafes || cafes.length === 0) return;
        
        // Crear coordenadas para la ruta
        const coordinates = [[origin.lng, origin.lat]];
        cafes.forEach(cafe => {
            coordinates.push([cafe.longitud || cafe.lng, cafe.latitud || cafe.lat]);
        });

        // Agregar fuente de datos para la ruta
        if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
        }

        map.addSource('route', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'properties': {},
                'geometry': {
                    'type': 'LineString',
                    'coordinates': coordinates
                }
            }
        });

        // Agregar capa de l√≠nea para la ruta
        map.addLayer({
            'id': 'route',
            'type': 'line',
            'source': 'route',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': '#d65a1a',
                'line-width': 4
            }
        });
    }

    // Load Mapbox API
    function loadMapbox() {
        const script = document.createElement('script');
        script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js';
        script.onload = () => {
            const link = document.createElement('link');
            link.href = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css';
            link.rel = 'stylesheet';
            document.head.appendChild(link);
            
            // Inicializar mapa cuando Mapbox est√© cargado
            initMap();
        };
        document.head.appendChild(script);
    }

    // Load maps when page is ready
    document.addEventListener('DOMContentLoaded', loadMapbox);
</script>
{% endblock %}
